# 委託業務作業レポート管理アプリ

合同会社SAT

## 目的
愛知県より委託される指定管理委託業務には、次の報告書及びデータの提出が必要である。
- 作業日報
- 捕獲個体毎の報告書
- 罠に関するデータ

## 報告書及び提出データの詳細
### 必要データ
#### 作業日報
- 作業日: 2025/4/30
- 作業時間: 10:00 - 12:00
- 作業者リスト: 伊藤淳、鈴木翔一郎、宮田清一
- 作業内容: 
    選択肢
    - わな猟調査(trap_research)
    - わな猟設置(trap_setting)
    - わな猟撤去(trap_check)
    - わな猟移設(trap_resetting)
    - わな猟見回り(trap_remove)
    - 銃猟調査(gun_research)
    - 銃猟誘引狙撃(gun_calling)
    - 銃猟巻き狩り(gun_driven_hunting)
    - 銃猟忍び猟(gun_sneak_hunting)
    - その他(other)
- 従事人数: 3
- 罠データ:
    - 罠の基数
    - 罠の管理番号
- 捕獲個体情報
    - 獣種類
    - 捕獲頭数
    - 処理方法
- 従事者の集合写真（作業者別の写真を複数添付してよい）

#### 捕獲実績報告書
- 捕獲個体管理番号: 25-001
- 捕獲日: 2025/4/30
- 捕獲場所の座標: 35.0956,138.8607
- 捕獲場所のメッシュ番号:
- 捕獲方法: 銃猟、くくり罠、箱罠、ネット式囲い罠
- 獣種類: イノシシ、ヌートリア
- 雌雄別: メス、オス
- 成獣幼獣別: 成獣、幼獣
- 頭胴長: 100cm
- 処理方法: 焼却, 自家消費, 埋設, 食肉加工
- 焼却または食肉加工した場合の関係施設: 施設名称

#### 捕獲個体別の実績写真報告書
- 捕獲個体管理番号: 25-001
- 実施地域名: 渥美半島地区
- 写真データ
    1. 止め刺し前の捕獲確認(image1): 捕獲方法が銃猟の場合は省略可
    1. 止め刺し後の捕獲確認(image2):
    1. 尻尾切除確認(image3):
    1. 処理確認1(image4):
        - 焼却: トラックの荷台で撮影
        - 自家消費: トラックの荷台で撮影
        - 埋設: 穴に獲物を入れた状態を撮影
        - 食肉加工: トラックの荷台で撮影
    1. 処理確認2(image5): 
        - 焼却: 施設搬入前で撮影
        - 自家消費: 解体作業を撮影
        - 埋設: 埋設後を撮影
        - 食肉加工: 施設搬入前で撮影
    1. 歯列写真(image6)


### フォーマットの指定
- 作業日報: あり
- 捕獲実績報告書: あり
- 捕獲個体別の実績写真報告書: あり


## システム設計
### データベース設計
データベースはAzure CosmosDBを利用する。
複数のデータ種類を1つのcontainerに格納し、パーティションキーでデータ種類を識別する。パーティションキーのフィールド名は "category" とする。
システムで用いる際は、全データをアプリ起動後に一括取得し、データ種類で分類してメモリに保存して利用することで応答性を向上させる。
データ追加・更新・削除時には、メモリを同期させる。

<br>
写真ファイルの保管としてOneDriveを利用する。

#### DB構成: パーティションキー
1. 作業日報データ: daily
1. 捕獲実績データ: result
1. 罠管理データ: trap
1. 従事者データ: user


#### データ種類ごとのフィールド及びサンプルデータ
##### 作業日報データ
作業種類×従事者×写真ファイルを記録
```
record = {
    "category": "daily",
    "fy": "2025年度",
    "users": ["伊藤淳", "鈴木翔一郎"], # 複数名での作業の場合もある
    "task_type": "わな猟見回り",
    "task_date": "2025-02-16",
    "start_time": "10:00",
    "end_time": "12:00",
    "images": [
        {
            "name": "20250216190359_patrol_0.jpg",
        },
        {
            "name": "20250216190359_patrol_1.jpg",
        }
    ],
    "comment": "-",
}
```

##### 捕獲実績データ
捕獲個体毎に記録
```
record = {
    "category": "result",
    "fy": "2025年度",
    "result_id": "IA001"
    "users": ["伊藤淳", "鈴木翔一郎"],
    "catch_date": "2025-02-16",
    "catch_method": くくり罠、箱罠、巻き狩り、忍び猟、誘引狙撃
    "trap": "T001",
    "sex": "オス",
    "adult": "成獣",
    "size": 100,
    "latitude": 35.0956,
    "longitude": 138.8607
    "mesh": "D7252",
    "disposal": "埋設",
    "image1": [
        {"name": "20250216190359_IA001_1.jpg"},
    ],
    "image2": [
        {"name": "20250216190359_IA001_2.jpg"},
    ],
    "image3": [
        {"name": "20250216190359_IA001_3.jpg"},
    ],
    "image4": [
        {"name": "20250216190359_IA001_4.jpg"},
    ],
    "image5": [
        {"name": "20250216190359_IA001_5.jpg"},
    ],
    "image6": [
        {"name": "20250216190359_IA001_6.jpg"},
    ],
    "comment": "-",
}
```

##### 罠管理データ
罠ごとのデータを記録
```
record = {
    "category": "trap",
    "fy": "2025年度",
    "trap_id": "T001",
    "latitude": 34.6972,
    "longitude": 137.2825,
    "mesh": "D7252",
    "number": 3,
    "status": "稼働中",
    "start_date": "2025-02-15",
    "end_date": "2025-03-21",
    "trap_name": "自宅の罠",
    "trap_type": "くくり",
    "images": [
        {
            "name": "20250216190359_T001_0.jpg",
        },
        {
            "name": "20250216190359_T001_1.jpg",
        }
    ],
}
```

##### 従事者データ
従事者リスト：各データ作成時の従事者候補に使用
```
record = {
    "category": "user",
    "user_name": "鈴木翔一郎",
    "user_code": "SS",
    "admin": True,
}
```

##### 写真保管(One Drive)
- daily_report ディレクトリに一括保存
- ファイル命名規則: {yyyymmddhhMMss}_{ファイル種類命名}_{index}


#### データ入力規則
##### 作業日報データ
|フィールド|データソース|
|---|---|
|category|既定: "daily"|
|fy|4月1日から翌年3月31日までを当年度とする|
|users|従事者データで取得した従業員からリスト表示しUIで選択(複数選択可能)|
|task_type|作業内容の選択肢からUIで選択|
|task_date|アプリ起動日をデフォルトとしてUIで選択|
|start_time|作業時間を入力してend_timeから作業時間を差算|
|end_time|データ送信時刻|
|images|UIからアップロード|
|images: name|ファイル命名規則: {yyyymmddhhMMss}_{ファイル種類命名}_{index}|
|comment|UIで任意入力|

##### 捕獲実績データ
|フィールド|データソース|
|---|---|
|category|既定: "result"|
|fy|4月1日から翌年3月31日までを当年度とする|
|result_id|一意のID(捕獲実績IDの採番機能を別途実装)|
|users|従事者データで取得した従業員からリスト表示しUIで選択(複数選択可能)|
|catch_date|アプリ起動日をデフォルトとしてUIで選択|
|catch_method|捕獲方法の選択肢からUIで選択|
|trap_id|罠管理データを参照したリストからユーザーがUIで選択|
|sex|UIで選択:["オス", "メス"]|
|adult|UIで選択:["成獣", "幼獣"]|
|size|UIで選択|
|latitude|image1ファイルの位置情報メタデータから取得|
|longitude|image1ファイルの位置情報メタデータから取得|
|mesh|座標データから生成(別途生成関数を実装)|
|disposal|処理方法の選択肢からUIで選択|
|image1|UIからアップロード|
|image2|UIからアップロード|
|image3|UIからアップロード|
|image4|UIからアップロード|
|image5|UIからアップロード|
|image6|UIからアップロード|
|comment|UIで任意入力|

##### 罠管理データ
|フィールド|データソース|
|---|---|
|category|既定: "trap"|
|fy|4月1日から翌年3月31日までを当年度とする|
|trap_id|一意のID(罠管理IDの採番機能を別途実装)|
|latitude|imagesの1つ目のファイルの位置情報メタデータから取得|
|longitude|imagesの1つ目のファイルの位置情報メタデータから取得|
|mesh|座標データから生成(別途生成関数を実装)|
|number|UIで入力。同一スポット内の基数を入力|
|status|UIで選択（稼働、撤去済）|
|task_date|アプリ起動日をデフォルトとしてUIで選択|
|trap_name|UIで任意入力|
|trap_type|UIで任意入力|
|images|UIからアップロード|
|images: name|ファイル命名規則: {yyyymmddhhMMss}_{ファイル種類命名}_{index}|

##### 従事者データ
|フィールド|データソース|
|---|---|
|category|既定: "user"|
|user_name|UIで任意入力|
|user_code|一意のコードを任意で入力|
|admin|UIで入力|


#### データライフサイクル設計
##### 作業日報データ
- 追加及び訂正を基本とする。
- 登録間違い時のみ削除する。
- ユーザー、作業内容、日付が同一レコードの二重登録を拒絶する処理を組み込む。

##### 捕獲実績データ
- 捕獲実績IDの採番システム: {user_code}{ユーザー毎の3桁連番}
    - 現地で捕獲個体にIDをマーキングして写真撮影する必要があるため、現地の電波が不調でも採番できるルールとする。
    - 一意の user_code + ユーザー毎の連番とすることで、スマホで直近の捕獲画像から連番を確認してシステムを介さずに次の捕獲実績IDが把握できる
- 捕獲実績IDは年度毎でリセット

##### 罠管理データ
- 罠管理IDはスポット単位（近距離の複数基をまとめて"スポット"という）
- 罠管理IDの採番システム: {2桁連番}
（罠管理IDはシステム上でのみ採番できればよい）
- 箱罠などの複数年度に渡って利用するものも、各年度ごとに新規登録する。
- 罠管理IDは年度毎でリセット

##### 従事者データ
- 経年によるライフサイクルは考慮しない。
- 新規登録 ＞ 必要に応じて修正 ＞ 削除のサイクルとする
- 削除する場合は物理削除とする。


#### バリデーション処理フロー
1. UIからの入力受信（画像ファイル・任意の手動入力）
2. 画像ファイルのExifデータから位置・撮影日時を取得
   - 取得失敗時は手動入力モードへフォールバック
3. 下記ルールに基づきバリデーション：
   - 座標：緯度・経度が指定範囲内
   - 撮影日：過去日時かつ報告対象月内
   - 画像枚数：各地点1〜10枚
4. バリデーション通過後、CosmosDB用データスキーマへ変換

#### Exif情報欠損時の対応
- Exif取得失敗時は、ユーザーに「緯度・経度・撮影日」の手動入力フォームを表示する。
- 手動入力された情報はExifと同様にDBに登録可能。
- `"exif_available": false`を付与して、後から抽出・検査可能な状態を維持する。


### レポート生成処理手順
処理用の設定ファイルとして以下を用意するものとする
- レポートフォーマット用のExcelテンプレート各種（作業日報、捕獲実績報告書、捕獲個体別の実績写真報告書、罠捕獲に関する必要データ）
- 各Excelテンプレートのデータ埋め込むセルのマッピングデータ（データ項目×セル("A1")）

#### 作業日報
1. 作成するレポートの日付をtask_dateとして特定
1. task_date で作業日報データを抽出
1. task_date で捕獲実績データを抽出
1. 罠管理データから task_date で稼働中の罠を抽出
1. task_type で作業日報データ抽出データを集計: 
    - 各作業の作業人数
    - 全作業にかかわった作業者を整理
    - 罠に関する作業は作業ごとの罠管理IDの整理と罠数のカウント
1. 捕獲データを集計: 
    - 捕獲数
    - 処分方法別の数量
1. テンプレートのセルのマッピングデータをロード
1. Excel テンプレートファイルをコピーし、日付を付したファイル名を作成
1. Excel テンプレートファイルにデータを挿入
1. 作業日報データのレコードから、写真ファイルをダウンロード
1. Excel テンプレートファイルに写真ファイルを縦横比を保持したまま縮小して挿入
1. Excel ファイルを保存

#### 捕獲実績報告書
1. 作成するレポートの期間をtask_datesとして特定
1. task_dates で捕獲実績データを抽出
1. 罠管理データから全データを抽出
1. データ整形 
1. テンプレートのセルのマッピングデータをロード
1. Excel テンプレートファイルをコピーし、日付を付したファイル名を作成
1. Excel テンプレートファイルにデータを挿入: 指定期間中の捕獲実績レコード分のテーブル行を追加
1. Excel ファイルを保存

#### 捕獲個体別の実績写真報告書
1. 作成するレポートの日付をcatch_dateとして特定
1. 罠管理データから全データを抽出
1. catch_date で捕獲実績データを抽出: 以下、同日中に捕獲した各レコード毎に処理
1. データ整形
1. テンプレートのセルのマッピングデータをロード
1. Excel テンプレートファイルをコピーし、日付を付したファイル名を作成
1. Excel テンプレートファイルにデータを挿入
1. 捕獲実績データのレコードから、写真ファイルをダウンロード
1. Excel テンプレートファイルに写真ファイルを縦横比を保持したまま縮小して挿入
1. Excel ファイルを保存

### UI設計
利用はスマートフォンがメインとなるため、スマホで見やすい構成とする

- Top画面:
    1. データ一括読み取り処理
        - アプリ起動時に st.session_state データ有無をチェック
        - st.session_state がない場合はDBからデータロード
        - データ種類ごとに分類して st.session_state に保存
    1. ユーザー指定
        - 従事者データから得た従業員データ分のボタンを配置
        - ボタンクリックにて従事者を選択
- 日報登録画面
    1. 日報データの登録
    1. 日報データの閲覧
    1. 日報データの修正・削除
    1. 写真ファイルの差し替え
- 捕獲登録画面
    1. 捕獲データの登録
    1. 捕獲データの閲覧
    1. 捕獲データの修正・削除
    1. 捕獲写真ファイルの差し替え
- 罠管理画面
    1. 罠データの登録
    1. 罠データの閲覧
    1. 罠データの修正・削除
    1. 罠写真ファイルの差し替え
- ユーザー設定画面
    user["admin"]がtrueのユーザーのみ機能を使える
    1. ユーザーの追加
    1. ユーザーの修正・削除
